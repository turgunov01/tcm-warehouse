import{_ as R}from"./Doh9g-xE.js";import{_ as T,a as E}from"./89_6_WXE.js";import{_ as I}from"./CeTMl5KV.js";import{_ as L}from"./Bg2tV3qA.js";import{_ as j}from"./CKHeMAGH.js";import{_ as A}from"./hTEjwFDU.js";import{_ as G}from"./WaFNkPel.js";import{_ as P}from"./LHM2B4W_.js";import{e as H,h as J,j as K,c as O,a as d,l as a,v as w,m as U,w as s,b as l,r as p,o as y,k as Q,d as V,t as C,p as W}from"./C3nFx1By.js";import{u as X}from"./BHGEb1MA.js";import"./DLtK76PB.js";import"./zCT-49bZ.js";import"./BNwErHV-.js";import"./vTvZ5yAG.js";const Y={class:"space-y-4"},Z={class:"grid gap-3 md:grid-cols-2 xl:grid-cols-4"},h={class:"mt-3"},ee={class:"grid gap-4 xl:grid-cols-2"},te={class:"grid gap-3 md:grid-cols-2"},le={class:"space-y-3"},ke=H({__name:"settings",setup(ae){const i=J(),{getFirstFile:z}=X(),o=p(null),g=p([]),x=p([]),m=p(""),n=W({zone_id:"",starts_at:"",ends_at:"",reason:""}),c=p(null),b=async()=>{const[r,e,k]=await Promise.all([i.from("settings").select("*").eq("id",1).single(),i.from("closures").select("*").order("starts_at",{ascending:!1}),i.from("zones").select("*").order("name")]);o.value=r.data?{...r.data,break_start:r.data.break_start||"",break_end:r.data.break_end||""}:null,g.value=e.data??[],x.value=k.data??[]},F=async()=>{if(!o.value)return;const{error:r}=await i.from("settings").update({free_start:o.value.free_start,free_end:o.value.free_end,work_start:o.value.work_start,work_end:o.value.work_end,break_start:o.value.break_start||null,break_end:o.value.break_end||null,hourly_penalty:o.value.hourly_penalty,debt_block_hours:o.value.debt_block_hours}).eq("id",1);m.value=r?r.message:"Настройки сохранены.",await b()},S=async()=>{const{error:r}=await i.from("closures").insert({zone_id:n.zone_id||null,starts_at:n.starts_at,ends_at:n.ends_at,reason:n.reason});m.value=r?r.message:"Ограничение добавлено.",n.zone_id="",n.starts_at="",n.ends_at="",n.reason="",await b()},q=async r=>{await i.from("closures").update({is_active:!r.is_active}).eq("id",r.id),await b()},B=async()=>{if(!c.value)return;const r=`${Date.now()}-${c.value.name}`,{error:e}=await i.storage.from("templates").upload(r,c.value,{upsert:!0});m.value=e?e.message:"Шаблон загружен в хранилище templates."};return K(b),(r,e)=>{const k=R,u=E,_=T,f=I,v=L,M=j,$=A,D=G,N=P;return y(),O("div",Y,[e[17]||(e[17]=d("div",null,[d("h1",{class:"text-2xl font-semibold"},"Настройки"),d("p",{class:"text-sm text-slate-500"},"Временные окна, ограничения, штрафы и лимиты долга.")],-1)),a(m)?(y(),w(k,{key:0,title:a(m),color:"primary",variant:"subtle"},null,8,["title"])):U("",!0),a(o)?(y(),w(v,{key:1},{header:s(()=>[...e[13]||(e[13]=[d("p",{class:"font-semibold"},"Правила времени",-1)])]),default:s(()=>[d("div",Z,[l(_,{label:"Начало бесплатного окна"},{default:s(()=>[l(u,{modelValue:a(o).free_start,"onUpdate:modelValue":e[0]||(e[0]=t=>a(o).free_start=t),type:"time"},null,8,["modelValue"])]),_:1}),l(_,{label:"Конец бесплатного окна"},{default:s(()=>[l(u,{modelValue:a(o).free_end,"onUpdate:modelValue":e[1]||(e[1]=t=>a(o).free_end=t),type:"time"},null,8,["modelValue"])]),_:1}),l(_,{label:"Начало рабочего окна"},{default:s(()=>[l(u,{modelValue:a(o).work_start,"onUpdate:modelValue":e[2]||(e[2]=t=>a(o).work_start=t),type:"time"},null,8,["modelValue"])]),_:1}),l(_,{label:"Конец рабочего окна"},{default:s(()=>[l(u,{modelValue:a(o).work_end,"onUpdate:modelValue":e[3]||(e[3]=t=>a(o).work_end=t),type:"time"},null,8,["modelValue"])]),_:1}),l(_,{label:"Начало перерыва"},{default:s(()=>[l(u,{modelValue:a(o).break_start,"onUpdate:modelValue":e[4]||(e[4]=t=>a(o).break_start=t),type:"time"},null,8,["modelValue"])]),_:1}),l(_,{label:"Конец перерыва"},{default:s(()=>[l(u,{modelValue:a(o).break_end,"onUpdate:modelValue":e[5]||(e[5]=t=>a(o).break_end=t),type:"time"},null,8,["modelValue"])]),_:1}),l(_,{label:"Почасовой штраф"},{default:s(()=>[l(u,{modelValue:a(o).hourly_penalty,"onUpdate:modelValue":e[6]||(e[6]=t=>a(o).hourly_penalty=t),modelModifiers:{number:!0},type:"number"},null,8,["modelValue"])]),_:1}),l(_,{label:"Лимит долга (в часах)"},{default:s(()=>[l(u,{modelValue:a(o).debt_block_hours,"onUpdate:modelValue":e[7]||(e[7]=t=>a(o).debt_block_hours=t),modelModifiers:{number:!0},type:"number",step:"0.5"},null,8,["modelValue"])]),_:1})]),d("div",h,[l(f,{label:"Сохранить настройки",color:"white",onClick:F})])]),_:1})):U("",!0),d("div",ee,[l(v,null,{header:s(()=>[...e[14]||(e[14]=[d("p",{class:"font-semibold"},"Ограничения",-1)])]),default:s(()=>[l($,{state:a(n),class:"space-y-3",onSubmit:Q(S,["prevent"])},{default:s(()=>[l(_,{label:"Зона (необязательно)"},{default:s(()=>[l(M,{modelValue:a(n).zone_id,"onUpdate:modelValue":e[8]||(e[8]=t=>a(n).zone_id=t),options:a(x),"option-attribute":"name","value-attribute":"id"},null,8,["modelValue","options"])]),_:1}),d("div",te,[l(_,{label:"Начало"},{default:s(()=>[l(u,{modelValue:a(n).starts_at,"onUpdate:modelValue":e[9]||(e[9]=t=>a(n).starts_at=t),type:"datetime-local",required:""},null,8,["modelValue"])]),_:1}),l(_,{label:"Конец"},{default:s(()=>[l(u,{modelValue:a(n).ends_at,"onUpdate:modelValue":e[10]||(e[10]=t=>a(n).ends_at=t),type:"datetime-local",required:""},null,8,["modelValue"])]),_:1})]),l(_,{label:"Причина"},{default:s(()=>[l(u,{modelValue:a(n).reason,"onUpdate:modelValue":e[11]||(e[11]=t=>a(n).reason=t),required:""},null,8,["modelValue"])]),_:1}),l(f,{type:"submit",label:"Добавить ограничение"})]),_:1},8,["state"])]),_:1}),l(v,null,{header:s(()=>[...e[15]||(e[15]=[d("p",{class:"font-semibold"},"Загрузка шаблона",-1)])]),default:s(()=>[d("div",le,[e[16]||(e[16]=d("p",{class:"text-sm text-slate-500"},[V("Загрузите Excel-шаблон в хранилище "),d("code",null,"templates"),V(".")],-1)),l(u,{type:"file",accept:".xlsx,.xls",onChange:e[12]||(e[12]=t=>c.value=a(z)(t))}),l(f,{label:"Загрузить шаблон",onClick:B})])]),_:1})]),l(v,null,{default:s(()=>[l(N,{rows:a(g),columns:[{key:"starts_at",label:"Начало"},{key:"ends_at",label:"Конец"},{key:"reason",label:"Причина"},{key:"is_active",label:"Активно"},{key:"actions",label:"Действия"}]},{"starts_at-data":s(({row:t})=>[V(C(new Date(t.starts_at).toLocaleString()),1)]),"ends_at-data":s(({row:t})=>[V(C(new Date(t.ends_at).toLocaleString()),1)]),"is_active-data":s(({row:t})=>[l(D,{label:t.is_active?"Да":"Нет",color:t.is_active?"green":"gray"},null,8,["label","color"])]),"actions-data":s(({row:t})=>[l(f,{size:"xs",label:t.is_active?"Выключить":"Включить",onClick:oe=>q(t)},null,8,["label","onClick"])]),_:1},8,["rows"])]),_:1})])}}});export{ke as default};
