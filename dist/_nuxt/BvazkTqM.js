import{_ as V,a as U}from"./89_6_WXE.js";import{_ as C}from"./CeTMl5KV.js";import{_ as S}from"./hTEjwFDU.js";import{_ as B}from"./Bg2tV3qA.js";import{e as M,g as T,h as q,i as A,j as I,c as f,b as r,w as i,r as w,n as x,o as h,k as N,l as a,t as P,m as F,a as c,p as R}from"./C3nFx1By.js";import"./DLtK76PB.js";import"./zCT-49bZ.js";import"./BNwErHV-.js";const $={class:"mx-auto flex min-h-screen w-full max-w-md items-center px-4"},j={key:0,class:"text-sm text-rose-600"},Q=M({__name:"login",setup(D){const b=T(),p=q(),{loadProfile:d,roleHome:_}=A(),o=R({username:"",password:""}),l=w(!1),n=w("");b.query.reason==="profile_missing"&&(n.value="Аккаунт авторизован, но профиль отсутствует. Добавьте запись в public.profiles для этого пользователя."),I(async()=>{const{data:s}=await p.auth.getSession(),e=s.session?.user;if(!e)return;const t=await d(e.id);t&&await x(_(t.role),{replace:!0})});const g=async()=>{l.value=!0,n.value="";try{const s=await $fetch("/api/auth/login",{method:"POST",body:{username:o.username,password:o.password}}),{data:e,error:t}=await p.auth.setSession({access_token:s.access_token,refresh_token:s.refresh_token});if(t){n.value=t.message,l.value=!1;return}const u=await d(e.user?.id);if(l.value=!1,!u){n.value="Профиль не найден. Попросите администратора создать профиль в public.profiles.";return}await x(_(u.role),{replace:!0})}catch(s){n.value=s?.data?.statusMessage||s?.data?.message||s?.message||"Не удалось выполнить вход",l.value=!1}};return(s,e)=>{const t=U,u=V,v=C,y=S,k=B;return h(),f("div",$,[r(k,{class:"w-full"},{header:i(()=>[...e[2]||(e[2]=[c("div",{class:"space-y-1"},[c("h1",{class:"text-xl font-semibold"},"Вход в TCM Warehouse"),c("p",{class:"text-sm text-slate-500"},"Используйте выданные учетные данные.")],-1)])]),default:i(()=>[r(y,{state:a(o),class:"space-y-3",onSubmit:N(g,["prevent"])},{default:i(()=>[r(u,{label:"Логин",name:"username"},{default:i(()=>[r(t,{modelValue:a(o).username,"onUpdate:modelValue":e[0]||(e[0]=m=>a(o).username=m),required:""},null,8,["modelValue"])]),_:1}),r(u,{label:"Пароль",name:"password"},{default:i(()=>[r(t,{modelValue:a(o).password,"onUpdate:modelValue":e[1]||(e[1]=m=>a(o).password=m),type:"password",required:""},null,8,["modelValue"])]),_:1}),a(n)?(h(),f("p",j,P(a(n)),1)):F("",!0),r(v,{type:"submit",block:"",color:"white",loading:a(l),label:"Войти"},null,8,["loading"])]),_:1},8,["state"])]),_:1})])}}});export{Q as default};
