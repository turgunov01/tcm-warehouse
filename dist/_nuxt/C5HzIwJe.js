import{_ as ae}from"./CeTMl5KV.js";import{_ as oe}from"./Bj5gw5IS.js";import{_ as se,a as le,b as ne}from"./CDRKptRF.js";import{_ as re}from"./Bg2tV3qA.js";import{_ as ie,a as ue}from"./89_6_WXE.js";import{_ as de}from"./CKHeMAGH.js";import{a as _e}from"./LHM2B4W_.js";import{_ as pe}from"./hTEjwFDU.js";import{_ as me}from"./Bp_7xjuY.js";import{e as ce,h as fe,U as ve,i as be,j as ge,q as h,c as z,a as _,b as o,s as N,l,w as i,v as L,r as p,o as S,k as xe,t as E,m as we,p as ke,y as U}from"./C3nFx1By.js";import{u as ye}from"./YQB72Io7.js";import"./zCT-49bZ.js";import"./BOtwTEl-.js";import"./WaFNkPel.js";import"./BNwErHV-.js";import"./DLtK76PB.js";import"./vTvZ5yAG.js";const $e={class:"space-y-4"},qe={class:"flex flex-wrap items-center justify-between gap-3"},Ve={class:"flex justify-end"},he={class:"text-xs text-slate-500"},Se={key:0,class:"text-sm text-slate-600"},Ue={class:"flex justify-end gap-2"},Re=ce({__name:"bookings",setup(Ce){const C=fe(),b=ve(),{fetchBookings:H,fetchSettings:I}=ye(),{profile:D,loadProfile:O}=be(),y=p([]),g=p("table"),u=p({from:"",to:"",statuses:[]}),m=p(!1),$=p(!1),d=p(""),T=p(null),M=p([]),a=ke({driver_name:"",car_plate_text:"",requested_datetime:"",is_express:!1,driver_passport_front:null,driver_passport_back:null,car_plate_photo:null}),f=t=>String(t).padStart(2,"0"),j=t=>`${t.getFullYear()}-${f(t.getMonth()+1)}-${f(t.getDate())}T${f(t.getHours())}:${f(t.getMinutes())}`,P=t=>t.toLocaleString([],{weekday:"short",month:"short",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1}),G=t=>`${t.getFullYear()}-${f(t.getMonth()+1)}-${f(t.getDate())}`,K=t=>{const r=[];for(let c=0;c<=1140;c+=30){const x=c,w=new Date(t);w.setHours(Math.floor(x/60),x%60,0,0),r.push({label:P(w),value:j(w)})}return r},B=U(()=>{const t=new Date;return t.setHours(0,0,0,0),a.is_express||t.setDate(t.getDate()+1),t}),q=U(()=>{const t=new Set(M.value);return K(B.value).map(e=>({...e,disabled:t.has(e.value)}))}),R=U(()=>q.value.some(t=>!t.disabled)),F=(t,e)=>{let s=null;e instanceof FileList?s=e.item(0):Array.isArray(e)?s=e[0]??null:e&&typeof e=="object"&&"target"in e&&(s=e.target?.files?.[0]??null),a[t]=s},Y=async()=>{const t=G(B.value);let e=C.from("bookings").select("requested_datetime, status, zone_id").gte("requested_datetime",`${t}T00:00:00`).lte("requested_datetime",`${t}T23:59:59`).in("status",["pending","approved","arrived","left","completed"]);D.value?.zone_id&&(e=e.eq("zone_id",D.value.zone_id));const{data:s,error:r}=await e;if(r){M.value=[];return}M.value=Array.from(new Set((s??[]).map(c=>j(new Date(c.requested_datetime)))))},A=async t=>{if(!b.value)throw new Error("Пользователь не найден");const e=t.name.split(".").pop()||"bin",s=`${b.value.id}/${Date.now()}-${Math.random().toString(36).slice(2)}.${e}`,{error:r}=await C.storage.from("documents").upload(s,t,{upsert:!0});if(r)throw r;return s},W=U(()=>Number(T.value?.hourly_penalty||0)),J=async()=>{if(!a.requested_datetime){d.value="Выберите свободный слот даты и времени.";return}if(q.value.find(t=>t.value===a.requested_datetime)?.disabled){d.value="Выбранный слот уже занят. Пожалуйста, выберите другой.";return}if(!a.driver_passport_front||!a.driver_passport_back||!a.car_plate_photo){d.value="Нужно загрузить все документы.";return}$.value=!0,d.value="";try{const[t,e,s]=await Promise.all([A(a.driver_passport_front),A(a.driver_passport_back),A(a.car_plate_photo)]),{error:r}=await C.from("bookings").insert({driver_name:a.driver_name,driver_passport_front:t,driver_passport_back:e,car_plate_photo:s,car_plate_text:a.car_plate_text,requested_datetime:a.requested_datetime,is_express:a.is_express});if(r){d.value=r.message,$.value=!1;return}d.value="Бронирование создано.",m.value=!1,a.driver_name="",a.car_plate_text="",a.requested_datetime="",a.is_express=!1,a.driver_passport_front=null,a.driver_passport_back=null,a.car_plate_photo=null,await V()}catch(t){d.value=t?.message||"Не удалось создать бронирование"}finally{$.value=!1}},V=async()=>{if(!b.value?.id){y.value=[];return}y.value=await H({from:u.value.from?`${u.value.from}T00:00:00`:void 0,to:u.value.to?`${u.value.to}T23:59:59`:void 0,statuses:u.value.statuses,tenantIds:[b.value.id]})};return ge(async()=>{await O(),T.value=await I(),await V()}),h(u,V,{deep:!0}),h(()=>b.value?.id,()=>{V()}),h(q,t=>{const e=t.find(s=>s.value===a.requested_datetime);if(!e||e.disabled){const s=t.find(r=>!r.disabled);a.requested_datetime=s?.value||""}},{immediate:!0}),h([B,m,()=>D.value?.zone_id],async([,t])=>{t&&await Y()},{immediate:!0}),(t,e)=>{const s=ae,r=oe,c=ne,x=re,w=se,Q=le,k=ue,v=ie,X=de,Z=_e,ee=pe,te=me;return S(),z("div",$e,[_("div",qe,[e[13]||(e[13]=_("div",null,[_("h1",{class:"text-2xl font-semibold"},"Бронирования"),_("p",{class:"text-sm text-slate-500"},"Создание и отслеживание бронирований по зоне.")],-1)),o(s,{label:"Создать бронирование",color:"white",onClick:e[0]||(e[0]=n=>m.value=!0)})]),o(r,{modelValue:l(u),"onUpdate:modelValue":e[1]||(e[1]=n=>N(u)?u.value=n:null)},null,8,["modelValue"]),o(x,null,{default:i(()=>[_("div",Ve,[o(c,null,{default:i(()=>[o(s,{label:"Таблица",variant:l(g)==="table"?"solid":"outline",onClick:e[2]||(e[2]=n=>g.value="table")},null,8,["variant"]),o(s,{label:"Календарь",variant:l(g)==="calendar"?"solid":"outline",onClick:e[3]||(e[3]=n=>g.value="calendar")},null,8,["variant"])]),_:1})])]),_:1}),l(g)==="table"?(S(),L(w,{key:0,rows:l(y)},null,8,["rows"])):(S(),L(Q,{key:1,rows:l(y)},null,8,["rows"])),o(te,{modelValue:l(m),"onUpdate:modelValue":e[12]||(e[12]=n=>N(m)?m.value=n:null)},{default:i(()=>[o(x,null,{header:i(()=>[...e[14]||(e[14]=[_("p",{class:"font-semibold"},"Новое бронирование",-1)])]),default:i(()=>[o(ee,{state:l(a),class:"space-y-3",onSubmit:xe(J,["prevent"])},{default:i(()=>[o(v,{label:"Имя водителя"},{default:i(()=>[o(k,{modelValue:l(a).driver_name,"onUpdate:modelValue":e[4]||(e[4]=n=>l(a).driver_name=n),required:""},null,8,["modelValue"])]),_:1}),o(v,{label:"Номер машины"},{default:i(()=>[o(k,{modelValue:l(a).car_plate_text,"onUpdate:modelValue":e[5]||(e[5]=n=>l(a).car_plate_text=n),required:""},null,8,["modelValue"])]),_:1}),o(v,{label:"Желаемая дата и время"},{default:i(()=>[o(X,{modelValue:l(a).requested_datetime,"onUpdate:modelValue":e[6]||(e[6]=n=>l(a).requested_datetime=n),options:l(q),"option-attribute":"label","value-attribute":"value",disabled:!l(R),searchable:!1,placeholder:"Нет свободных слотов",required:""},null,8,["modelValue","options","disabled"])]),_:1}),o(Z,{modelValue:l(a).is_express,"onUpdate:modelValue":e[7]||(e[7]=n=>l(a).is_express=n),label:"Экспресс-бронирование (обязательно для заявок на сегодня)"},null,8,["modelValue"]),_("p",he,"Оценочная стоимость экспресса: "+E(l(W)),1),o(v,{label:"Паспорт (лицевая сторона)"},{default:i(()=>[o(k,{type:"file",accept:"image/*",required:"",onChange:e[8]||(e[8]=n=>F("driver_passport_front",n))})]),_:1}),o(v,{label:"Паспорт (обратная сторона)"},{default:i(()=>[o(k,{type:"file",accept:"image/*",required:"",onChange:e[9]||(e[9]=n=>F("driver_passport_back",n))})]),_:1}),o(v,{label:"Фото госномера"},{default:i(()=>[o(k,{type:"file",accept:"image/*",required:"",onChange:e[10]||(e[10]=n=>F("car_plate_photo",n))})]),_:1}),l(d)?(S(),z("p",Se,E(l(d)),1)):we("",!0),_("div",Ue,[o(s,{label:"Отмена",variant:"ghost",onClick:e[11]||(e[11]=n=>m.value=!1)}),o(s,{type:"submit",label:"Отправить",color:"white",loading:l($)},null,8,["loading"])])]),_:1},8,["state"])]),_:1})]),_:1},8,["modelValue"])])}}});export{Re as default};
