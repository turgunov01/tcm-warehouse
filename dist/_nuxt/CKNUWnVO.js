import{_ as A}from"./Doh9g-xE.js";import{_ as D,a as H}from"./89_6_WXE.js";import{N as L,O as I,_ as P,o as N,c as M,a as B,P as G,W as E,H as J,e as T,r as w,a1 as W,j as U,q as K,y as j,a2 as Q,R as $,M as X,S as Y,T as Z,h as ee,l as u,v as te,m as ae,b as i,w as f,k as oe,d as le,t as ne,p as se}from"./C3nFx1By.js";import{t as re,u as ue,_ as ie}from"./Bg2tV3qA.js";import{u as de}from"./DLtK76PB.js";import{_ as ce}from"./CKHeMAGH.js";import{_ as me}from"./CeTMl5KV.js";import{_ as pe}from"./hTEjwFDU.js";import{_ as fe}from"./LHM2B4W_.js";import{u as _e}from"./BOtwTEl-.js";import"./BNwErHV-.js";import"./vTvZ5yAG.js";import"./zCT-49bZ.js";const p=L(I.ui.strategy,I.ui.textarea,re),ye=T({inheritAttrs:!1,props:{modelValue:{type:[String,Number],default:""},id:{type:String,default:null},name:{type:String,default:null},placeholder:{type:String,default:null},required:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1},rows:{type:Number,default:3},maxrows:{type:Number,default:0},autoresize:{type:Boolean,default:!1},autofocus:{type:Boolean,default:!1},autofocusDelay:{type:Number,default:100},resize:{type:Boolean,default:!1},padded:{type:Boolean,default:!0},size:{type:String,default:null,validator(e){return Object.keys(p.size).includes(e)}},color:{type:String,default:()=>p.default.color,validator(e){return[...I.ui.colors,...Object.keys(p.color)].includes(e)}},variant:{type:String,default:()=>p.default.variant,validator(e){return[...Object.keys(p.variant),...Object.values(p.color).flatMap(o=>Object.keys(o))].includes(e)}},textareaClass:{type:String,default:null},class:{type:[String,Object,Array],default:()=>""},ui:{type:Object,default:()=>({})},modelModifiers:{type:Object,default:()=>({})}},emits:["update:modelValue","blur","change"],setup(e,{emit:o}){const{ui:s,attrs:y}=ue("textarea",$(e,"ui"),p,$(e,"class")),{emitFormBlur:b,emitFormInput:l,inputId:r,color:v,size:x,name:V}=de(e,p),n=w(W({},e.modelModifiers,{trim:!1,lazy:!1,number:!1,nullify:!1})),t=w(null),m=()=>{e.autofocus&&t.value?.focus()},g=()=>{if(e.autoresize){if(!t.value)return;t.value.rows=e.rows;const a=t.value.style.overflow;t.value.style.overflow="hidden";const d=window.getComputedStyle(t.value),c=Number.parseInt(d.paddingTop),O=Number.parseInt(d.paddingBottom),R=c+O,q=Number.parseInt(d.lineHeight),{scrollHeight:F}=t.value,z=(F-R)/q;z>e.rows&&(t.value.rows=e.maxrows?Math.min(z,e.maxrows):z),t.value.style.overflow=a}},_=a=>{n.value.trim&&(a=a.trim()),n.value.number&&(a=Q(a)),n.value.nullify&&(a||=null),o("update:modelValue",a),l()},C=a=>{g(),n.value.lazy||_(a.target.value)},S=a=>{const d=a.target.value;o("change",d),n.value.lazy&&_(d),n.value.trim&&(a.target.value=d.trim())},h=a=>{o("blur",a),b()};U(()=>{setTimeout(()=>{m()},e.autofocusDelay)}),K(()=>e.modelValue,()=>{X(g)}),U(()=>{setTimeout(()=>{m(),g()},100)});const k=j(()=>{const a=s.value.color?.[v.value]?.[e.variant]||s.value.variant[e.variant];return Y(Z(s.value.base,s.value.form,s.value.rounded,s.value.placeholder,s.value.size[x.value],e.padded?s.value.padding[x.value]:"p-0",a?.replaceAll("{color}",v.value),!e.resize&&"resize-none"),e.textareaClass)});return{ui:s,attrs:y,name:V,inputId:r,textarea:t,textareaClass:k,onInput:C,onChange:S,onBlur:h}}}),be=["id","value","name","rows","required","disabled","placeholder"];function ve(e,o,s,y,b,l){return N(),M("div",{class:J(e.ui.wrapper)},[B("textarea",G({id:e.inputId,ref:"textarea",value:e.modelValue,name:e.name,rows:e.rows,required:e.required,disabled:e.disabled,placeholder:e.placeholder,class:e.textareaClass},e.attrs,{onInput:o[0]||(o[0]=(...r)=>e.onInput&&e.onInput(...r)),onBlur:o[1]||(o[1]=(...r)=>e.onBlur&&e.onBlur(...r)),onChange:o[2]||(o[2]=(...r)=>e.onChange&&e.onChange(...r))}),null,16,be),E(e.$slots,"default")],2)}const ge=P(ye,[["render",ve]]),we={class:"space-y-4"},Te=T({__name:"notifications",setup(e){const o=ee(),{roleLabel:s}=_e(),y=w([]),b=w([]),l=se({title:"",body:"",recipient_id:""}),r=w(""),v=async()=>{const[n,t]=await Promise.all([o.from("profiles").select("id, full_name, role").order("full_name"),o.from("notifications").select("*").order("created_at",{ascending:!1})]);y.value=(n.data??[]).map(m=>({...m,label:`[${m.full_name||"Без имени"}] [${s(m.role)}]`})),b.value=t.data??[]},x=j(()=>b.value.map(n=>({...n,recipient_display:n.recipient_id||"Всем пользователям"}))),V=async()=>{const{error:n}=await o.from("notifications").insert({title:l.title,body:l.body,recipient_id:l.recipient_id||null});r.value=n?n.message:"Уведомление отправлено.",l.title="",l.body="",l.recipient_id="",await v()};return U(v),(n,t)=>{const m=A,g=H,_=D,C=ge,S=ce,h=me,k=pe,a=ie,d=fe;return N(),M("div",we,[t[3]||(t[3]=B("div",null,[B("h1",{class:"text-2xl font-semibold"},"Уведомления"),B("p",{class:"text-sm text-slate-500"},"Создавайте массовые или персональные уведомления.")],-1)),u(r)?(N(),te(m,{key:0,title:u(r),color:"primary",variant:"subtle"},null,8,["title"])):ae("",!0),i(a,null,{default:f(()=>[i(k,{state:u(l),class:"space-y-3",onSubmit:oe(V,["prevent"])},{default:f(()=>[i(_,{label:"Заголовок"},{default:f(()=>[i(g,{modelValue:u(l).title,"onUpdate:modelValue":t[0]||(t[0]=c=>u(l).title=c),required:""},null,8,["modelValue"])]),_:1}),i(_,{label:"Сообщение"},{default:f(()=>[i(C,{modelValue:u(l).body,"onUpdate:modelValue":t[1]||(t[1]=c=>u(l).body=c),required:""},null,8,["modelValue"])]),_:1}),i(_,{label:"Получатель (пусто = всем)"},{default:f(()=>[i(S,{modelValue:u(l).recipient_id,"onUpdate:modelValue":t[2]||(t[2]=c=>u(l).recipient_id=c),options:u(y),"option-attribute":"label","value-attribute":"id",searchable:"",placeholder:"Все пользователи","clear-search-on-close":""},null,8,["modelValue","options"])]),_:1}),i(h,{type:"submit",label:"Отправить",color:"white"})]),_:1},8,["state"])]),_:1}),i(a,null,{default:f(()=>[i(d,{rows:u(x),columns:[{key:"created_at",label:"Создано"},{key:"title",label:"Заголовок"},{key:"body",label:"Сообщение"},{key:"recipient_display",label:"Получатель"}]},{"created_at-data":f(({row:c})=>[le(ne(new Date(c.created_at).toLocaleString()),1)]),_:1},8,["rows"])]),_:1})])}}});export{Te as default};
