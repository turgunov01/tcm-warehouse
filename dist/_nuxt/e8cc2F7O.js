import{_ as $,a as B}from"./89_6_WXE.js";import{_ as E}from"./CKHeMAGH.js";import{_ as N}from"./CeTMl5KV.js";import{_ as T}from"./hTEjwFDU.js";import{_ as h}from"./Bg2tV3qA.js";import{_ as q}from"./Doh9g-xE.js";import{_ as M}from"./LHM2B4W_.js";import{e as O,h as P,j as R,c as D,a as s,b as o,w as n,l as a,v as I,m as j,r as i,o as w,k as A,d as G,t as H,p as J}from"./C3nFx1By.js";import{u as K}from"./BHGEb1MA.js";import{u as Q}from"./BOtwTEl-.js";import"./DLtK76PB.js";import"./vTvZ5yAG.js";import"./zCT-49bZ.js";import"./BNwErHV-.js";const W={class:"space-y-4"},Y={class:"grid gap-4 xl:grid-cols-2"},Z={class:"grid gap-3 md:grid-cols-2"},ee={class:"grid gap-3 md:grid-cols-2"},le={class:"grid gap-3 md:grid-cols-2"},ae={class:"space-y-3"},Ve=O({__name:"users",setup(oe){const v=P(),{getFirstFile:U}=K(),{roleLabel:k}=Q(),V=i([]),g=i([]),_=i(!1),c=i(!1),u=i(""),z=[{label:"Арендатор",value:"tenant"},{label:"Охрана",value:"guard"},{label:"Администратор",value:"admin"}],l=J({username:"",email:"",password:"",role:"tenant",full_name:"",phone:"",zone_id:"",tenant_code:""}),f=async()=>{const[r,e]=await Promise.all([v.from("zones").select("*").order("name"),v.from("profiles").select("*").order("created_at",{ascending:!1})]);V.value=r.data??[],g.value=e.data??[]},S=async()=>{_.value=!0,u.value="";const{error:r}=await $fetch("/api/admin/create-user",{method:"POST",body:{...l,zone_id:l.zone_id||null,tenant_code:l.tenant_code||null}}).then(()=>({error:null})).catch(e=>({error:e}));if(_.value=!1,r){u.value=r.message;return}u.value="Пользователь создан.",l.username="",l.email="",l.password="",l.full_name="",l.phone="",l.tenant_code="",l.zone_id="",await f()},p=i(null),C=async()=>{if(!p.value){u.value="Сначала выберите Excel-файл.";return}c.value=!0,u.value="";const r=new FormData;r.append("file",p.value);try{const e=await $fetch("/api/admin/bulk-users",{method:"POST",body:r});u.value=`Массовая загрузка завершена. Добавлено: ${e.inserted}, Ошибок: ${e.failed}`,p.value=null,await f()}catch(e){u.value=e?.data?.message||e?.message||"Не удалось загрузить файл"}finally{c.value=!1}};return R(f),(r,e)=>{const m=B,d=$,x=E,y=N,F=T,b=h,L=q,X=M;return w(),D("div",W,[e[12]||(e[12]=s("div",null,[s("h1",{class:"text-2xl font-semibold"},"Пользователи"),s("p",{class:"text-sm text-slate-500"},"Создайте пользователя вручную или загрузите список из XLSX.")],-1)),s("div",Y,[o(b,null,{header:n(()=>[...e[9]||(e[9]=[s("p",{class:"font-semibold"},"Создание одного пользователя",-1)])]),default:n(()=>[o(F,{state:a(l),class:"space-y-3",onSubmit:A(S,["prevent"])},{default:n(()=>[s("div",Z,[o(d,{label:"Логин"},{default:n(()=>[o(m,{modelValue:a(l).username,"onUpdate:modelValue":e[0]||(e[0]=t=>a(l).username=t),required:""},null,8,["modelValue"])]),_:1}),o(d,{label:"Email"},{default:n(()=>[o(m,{modelValue:a(l).email,"onUpdate:modelValue":e[1]||(e[1]=t=>a(l).email=t),type:"email",required:""},null,8,["modelValue"])]),_:1})]),s("div",ee,[o(d,{label:"Пароль"},{default:n(()=>[o(m,{modelValue:a(l).password,"onUpdate:modelValue":e[2]||(e[2]=t=>a(l).password=t),type:"password",required:""},null,8,["modelValue"])]),_:1}),o(d,{label:"Роль"},{default:n(()=>[o(x,{modelValue:a(l).role,"onUpdate:modelValue":e[3]||(e[3]=t=>a(l).role=t),options:z,"option-attribute":"label","value-attribute":"value"},null,8,["modelValue"])]),_:1}),o(d,{label:"Зона"},{default:n(()=>[o(x,{modelValue:a(l).zone_id,"onUpdate:modelValue":e[4]||(e[4]=t=>a(l).zone_id=t),options:a(V),"option-attribute":"name","value-attribute":"id",placeholder:"Необязательно"},null,8,["modelValue","options"])]),_:1})]),s("div",le,[o(d,{label:"ФИО"},{default:n(()=>[o(m,{modelValue:a(l).full_name,"onUpdate:modelValue":e[5]||(e[5]=t=>a(l).full_name=t)},null,8,["modelValue"])]),_:1}),o(d,{label:"Телефон"},{default:n(()=>[o(m,{modelValue:a(l).phone,"onUpdate:modelValue":e[6]||(e[6]=t=>a(l).phone=t)},null,8,["modelValue"])]),_:1})]),o(d,{label:"Код арендатора"},{default:n(()=>[o(m,{modelValue:a(l).tenant_code,"onUpdate:modelValue":e[7]||(e[7]=t=>a(l).tenant_code=t)},null,8,["modelValue"])]),_:1}),o(y,{type:"submit",label:"Создать пользователя",color:"white",loading:a(_)},null,8,["loading"])]),_:1},8,["state"])]),_:1}),o(b,null,{header:n(()=>[...e[10]||(e[10]=[s("p",{class:"font-semibold"},"Массовая загрузка XLSX",-1)])]),default:n(()=>[s("div",ae,[e[11]||(e[11]=s("p",{class:"text-sm text-slate-500"}," Поддерживаемые форматы: .xlsx и .xls. Ожидаемые колонки: email, password, role, full_name, phone, zone_name, tenant_code, username(необязательно) ",-1)),o(m,{type:"file",accept:".xlsx,.xls",onChange:e[8]||(e[8]=t=>p.value=a(U)(t))}),o(y,{label:"Загрузить XLSX",loading:a(c),onClick:C},null,8,["loading"])])]),_:1})]),a(u)?(w(),I(L,{key:0,title:a(u),color:"primary",variant:"subtle"},null,8,["title"])):j("",!0),o(b,null,{default:n(()=>[o(X,{rows:a(g),columns:[{key:"username",label:"Логин"},{key:"email",label:"Email"},{key:"full_name",label:"Имя"},{key:"role",label:"Роль"},{key:"phone",label:"Телефон"},{key:"tenant_code",label:"Код"}]},{"role-data":n(({row:t})=>[G(H(a(k)(t.role)),1)]),_:1},8,["rows"])]),_:1})])}}});export{Ve as default};
